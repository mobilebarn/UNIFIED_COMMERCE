extend schema @link(url: "https://specs.apollo.dev/federation/v2.0", import: ["@key", "@external", "@requires", "@provides", "@shareable"])

directive @goModel(model: String, models: [String!]) on OBJECT | INPUT_OBJECT | SCALAR | ENUM | INTERFACE | UNION
directive @goField(forceResolver: Boolean, name: String) on INPUT_FIELD_DEFINITION | FIELD_DEFINITION

extend type User @key(fields: "id") {
  id: ID! @external
}

# Extend the Address type from the inventory service
extend type Address @key(fields: "firstName lastName street1 street2 city state country postalCode") @shareable {
  firstName: String @external
  lastName: String @external
  street1: String @external
  street2: String @external
  city: String @external
  state: String @external
  country: String @external
  postalCode: String @external
}

type Query {
  # Cart queries
  cart(id: ID!): Cart
  carts(filter: CartFilter): [Cart!]!
  cartBySession(sessionId: String!): Cart
  
  # Line item queries
  cartLineItem(id: ID!): CartLineItem @shareable
}

type Mutation {
  # Cart mutations
  createCart(input: CreateCartInput!): Cart!
  updateCart(id: ID!, input: UpdateCartInput!): Cart!
  deleteCart(id: ID!): Boolean!
  
  # Line item mutations
  addCartLineItem(input: AddLineItemInput!): CartLineItem! @shareable
  updateCartLineItem(id: ID!, input: UpdateLineItemInput!): CartLineItem! @shareable
  removeCartLineItem(id: ID!): Boolean! @shareable
  
  # Cart actions
  clearCart(cartId: ID!): Boolean!
  applyDiscountCode(cartId: ID!, code: String!): Cart!
  removeDiscountCode(cartId: ID!, code: String!): Cart!
  updateShippingAddress(cartId: ID!, address: AddressInput!): Cart!
  updateBillingAddress(cartId: ID!, address: AddressInput!): Cart!
}

# Main Cart type with federation key
type Cart @key(fields: "id") @goModel(model: "unified-commerce/services/cart/models.Cart") {
  id: ID!
  sessionId: String!
  customerId: ID
  merchantId: ID!
  status: CartStatus!
  currency: String!
  
  # Customer Information
  customerEmail: String
  customerPhone: String
  customerFirstName: String
  customerLastName: String
  
  # Addresses
  billingAddress: Address
  shippingAddress: Address
  
  # Pricing Information
  subtotalPrice: Float!
  totalTax: Float!
  totalShipping: Float!
  totalDiscount: Float!
  totalPrice: Float!
  
  # Checkout Information
  checkoutStep: CheckoutStep!
  paymentMethodId: String
  shippingMethodId: String
  
  # Marketing
  discountCodes: [String!]!
  abandonedAt: String
  recoveredAt: String
  
  # Metadata
  notes: String
  attributes: JSON
  
  # Timestamps
  expiresAt: String
  completedAt: String
  createdAt: String!
  updatedAt: String
  
  # Relationships
  lineItems: [CartLineItem!]!
  taxLines: [CartTaxLine!]!
  shippingLines: [CartShippingLine!]!
  discountApplications: [CartDiscountApplication!]!
  
  # Federation - extend User relationship
  customer: User
}

type CartLineItem @goModel(model: "unified-commerce/services/cart/models.CartLineItem") @shareable {
  id: ID!
  cartId: ID!
  productId: ID!
  productVariantId: ID
  
  # Product Information
  name: String!
  sku: String!
  barcode: String
  productTitle: String
  variantTitle: String
  vendor: String
  productImage: String
  
  # Quantity and Pricing
  quantity: Int!
  price: Float!
  compareAtPrice: Float
  linePrice: Float!
  
  # Discounts and Tax
  totalDiscount: Float!
  taxable: Boolean!
  
  # Fulfillment
  requiresShipping: Boolean!
  isGiftCard: Boolean!
  
  # Metadata
  properties: JSON
  createdAt: String!
  updatedAt: String
  
  # Relationships
  cart: Cart!
  discountAllocations: [CartLineItemDiscountAllocation!]!
}

type CartTaxLine @goModel(model: "unified-commerce/services/cart/models.CartTaxLine") {
  id: ID!
  cartId: ID!
  title: String!
  rate: Float!
  price: Float!
  createdAt: String!
  updatedAt: String
}

type CartShippingLine @goModel(model: "unified-commerce/services/cart/models.CartShippingLine") {
  id: ID!
  cartId: ID!
  title: String!
  code: String
  price: Float!
  carrierIdentifier: String
  requestedFulfillmentServiceId: String
  createdAt: String!
  updatedAt: String
}

type CartDiscountApplication @goModel(model: "unified-commerce/services/cart/models.CartDiscountApplication") {
  id: ID!
  cartId: ID!
  type: DiscountType!
  title: String!
  description: String
  value: Float!
  valueType: DiscountValueType!
  allocationMethod: AllocationMethod!
  targetSelection: TargetSelection!
  targetType: TargetType!
  code: String
  createdAt: String!
  updatedAt: String
}

type CartLineItemDiscountAllocation @goModel(model: "unified-commerce/services/cart/models.CartLineItemDiscountAllocation") {
  id: ID!
  lineItemId: ID!
  discountApplicationId: ID!
  amount: Float!
  createdAt: String!
  updatedAt: String
}

# Enums
enum CartStatus {
  active
  abandoned
  completed
  expired
}

enum CheckoutStep {
  CART
  SHIPPING
  PAYMENT
  REVIEW
  COMPLETE
}

enum DiscountType {
  MANUAL
  CODE
  AUTOMATIC
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

enum DiscountValueType {
  FIXED
  PERCENTAGE
}

enum AllocationMethod {
  ACROSS
  EACH
}

enum TargetSelection {
  ALL
  ENTITLED
  EXPLICIT
}

enum TargetType {
  LINE_ITEM
  SHIPPING_LINE
}

# Input Types
input CartFilter {
  customerId: ID
  merchantId: ID
  status: CartStatus
  sessionId: String
  limit: Int
  offset: Int
}

input CreateCartInput {
  sessionId: String!
  customerId: ID
  merchantId: ID!
  currency: String
  customerEmail: String
  customerPhone: String
  customerFirstName: String
  customerLastName: String
}

input UpdateCartInput {
  sessionId: String
  customerId: ID
  status: CartStatus
  currency: String
  customerEmail: String
  customerPhone: String
  customerFirstName: String
  customerLastName: String
  checkoutStep: CheckoutStep
  paymentMethodId: String
  shippingMethodId: String
  notes: String
  attributes: JSON
}

input AddLineItemInput {
  cartId: ID!
  productId: ID!
  productVariantId: ID
  quantity: Int!
  price: Float!
  name: String!
  sku: String!
  properties: JSON
}

input UpdateLineItemInput {
  quantity: Int
  price: Float
  properties: JSON
}

input AddressInput {
  firstName: String
  lastName: String
  company: String
  street1: String
  street2: String
  city: String
  state: String
  country: String
  postalCode: String
  phone: String
  latitude: Float
  longitude: Float
}

# Scalar for JSON data
scalar JSON